name: Nix Docker Image Creation

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - uses: nixbuild/nix-quick-install-action@v28
      - name: Build Image via Nix
        run: nix build .?submodules=1#docker
      - name: Load Image into Docker
        run: docker load < result
      - name: Log in to Docker Hub
        uses: docker/login-action@f4ef78c080cd8ba55a85445d5b36e214a81df20a
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Tag Image
        run: docker tag shino:latest nitrosniper/shino:latest
      - name: Push Image onto Docker Hub
        run: docker push nitrosniper/shino:latest
